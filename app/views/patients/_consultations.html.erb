<div class="patient-section">
  <div class="section-header">
    <h3><%= t('appointments_consultations') %></h3>
  </div>

  <% upcoming = patient.consultations.where("date_time > ?", Time.current).order(date_time: :asc) %>
  <% past = patient.consultations.where("date_time <= ?", Time.current).order(date_time: :desc) %>

  <% if upcoming.any? %>
    <h4><%= t('upcoming_appointments') %></h4>
    <ul class="consultations-list">
      <% upcoming.each do |consultation| %>
        <li>
          <div class="consultation-info">
            <strong><%= consultation.date_time.strftime("%B %d, %Y %H:%M") %></strong>
            <span>üìç <%= consultation.location.presence || t('not_specified') %></span>
            <p><em><%= consultation.notes %></em></p>
          </div>
          <div class="actions">
            <%= link_to t('open'), patient_consultation_path(patient, consultation), class: "button small secondary" %>
            <%= link_to "üìÖ", consultation.google_calendar_url, class: "button small", target: "_blank", title: t('add_to_google_calendar'), style: "padding: 0.4rem 0.8rem;" if consultation.google_calendar_url %>
            <%= button_to t('cancel'), patient_consultation_path(patient, consultation), method: :delete, class: "button small danger", form: { style: "display:inline-block;", data: { turbo_confirm: t('are_you_sure_appointment') } } %>
          </div>
        </li>
      <% end %>
    </ul>
  <% end %>

  <% if past.any? %>
    <h4 style="margin-top: 2rem;"><%= t('past_consultations') %></h4>
    <ul class="consultations-list">
      <% past.each do |consultation| %>
        <li>
          <div class="consultation-info">
            <strong><%= consultation.date_time.strftime("%B %d, %Y %H:%M") %></strong>
            <p><%= consultation.summary.presence || t('no_summary') %></p>
          </div>
          <div class="actions">
            <%= link_to t('view_details'), patient_consultation_path(patient, consultation), class: "button small secondary" %>
          </div>
        </li>
      <% end %>
    </ul>
  <% elsif upcoming.empty? %>
    <p><%= t('no_appointments') %></p>
  <% end %>

  <div class="add-form" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
    <h4><%= t('book_new_appointment') %></h4>
    <%= form_with(model: [patient, Consultation.new], local: true) do |form| %>
      <div class="form-group">
        <%= form.label :date_time, t('date_time') %>
        <%= form.datetime_field :date_time, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :location, t('location') %>
        <%= form.text_field :location, class: "form-control", placeholder: t('placeholder.appointment_location') %>
      </div>
      <div class="form-group">
        <%= form.label :notes, t('booking_notes') %>
        <%= form.text_area :notes, class: "form-control", placeholder: t('placeholder.appointment_reason') %>
      </div>
      <%= form.submit t('book_appointment'), class: "button small primary" %>
    <% end %>
  </div>
</div>
