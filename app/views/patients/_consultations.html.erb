<div class="patient-section">
  <div class="section-header">
    <h3>Appointments & Consultations</h3>
  </div>

  <% upcoming = patient.consultations.where("date_time > ?", Time.current).order(date_time: :asc) %>
  <% past = patient.consultations.where("date_time <= ?", Time.current).order(date_time: :desc) %>

  <% if upcoming.any? %>
    <h4>Upcoming Appointments</h4>
    <ul class="consultations-list">
      <% upcoming.each do |consultation| %>
        <li>
          <div class="consultation-info">
            <strong><%= consultation.date_time.strftime("%B %d, %Y %H:%M") %></strong>
            <span>üìç <%= consultation.location.presence || "No location" %></span>
            <p><em><%= consultation.notes %></em></p>
          </div>
          <div class="actions">
            <%= link_to "Open", patient_consultation_path(patient, consultation), class: "button small secondary" %>
            <%= button_to "Cancel", patient_consultation_path(patient, consultation), method: :delete, class: "button small danger", form: { style: "display:inline-block;", data: { turbo_confirm: "Are you sure you want to cancel this appointment?" } } %>
          </div>
        </li>
      <% end %>
    </ul>
  <% end %>

  <% if past.any? %>
    <h4 style="margin-top: 2rem;">Past Consultations</h4>
    <ul class="consultations-list">
      <% past.each do |consultation| %>
        <li>
          <div class="consultation-info">
            <strong><%= consultation.date_time.strftime("%B %d, %Y %H:%M") %></strong>
            <p><%= consultation.summary.presence || "No summary recorded." %></p>
          </div>
          <div class="actions">
            <%= link_to "View Details", patient_consultation_path(patient, consultation), class: "button small secondary" %>
          </div>
        </li>
      <% end %>
    </ul>
  <% elsif upcoming.empty? %>
    <p>No appointments or consultations recorded.</p>
  <% end %>

  <div class="add-form" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
    <h4>Book New Appointment</h4>
    <%= form_with(model: [patient, Consultation.new], local: true) do |form| %>
      <div class="form-group">
        <%= form.label :date_time, "Date & Time" %>
        <%= form.datetime_field :date_time, class: "form-control" %>
      </div>
      <div class="form-group">
        <%= form.label :location %>
        <%= form.text_field :location, class: "form-control", placeholder: "e.g. Room 302, Main Clinic" %>
      </div>
      <div class="form-group">
        <%= form.label :notes, "Booking Notes" %>
        <%= form.text_area :notes, class: "form-control", placeholder: "Reason for appointment..." %>
      </div>
      <%= form.submit "Book Appointment", class: "button small primary" %>
    <% end %>
  </div>
</div>
