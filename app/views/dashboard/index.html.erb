<div class="dashboard-container">
  
  <!-- Top Section: Patient List -->
  <div class="dashboard-section" style="margin-bottom: 2rem;">
    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3><%= t('patients') %></h3>
      <%= link_to t('new_patient'), new_patient_path, class: "button primary" %>
    </div>

    <div class="search-bar" style="margin-bottom: 1rem;">
      <%= form_with url: root_path, method: :get, local: true, style: "display: flex; width: 100%; gap: 0.5rem;" do |form| %>
        <%= form.text_field :query, placeholder: t('search_patients'), value: params[:query], class: "search-input form-control" %>
        <%= form.submit t('search'), class: "button secondary" %>
      <% end %>
    </div>

    <div class="patients-table-container">
      <table>
        <thead>
          <tr>
            <th><%= link_to t('name'), root_path(sort: "name", query: params[:query]) %></th>
            <th><%= t('identifier') %></th>
            <th><%= link_to t('registered'), root_path(sort: "created_at", query: params[:query]) %></th>
            <th><%= t('actions') %></th>
          </tr>
        </thead>
        <tbody>
          <% @patients.each do |patient| %>
            <tr>
              <td><%= link_to patient.name, patient %></td>
              <td><%= patient.identifier %></td>
              <td><%= patient.created_at.strftime("%b %d, %Y") %></td>
              <td>
                <%= link_to t('view'), patient, class: "button small secondary" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bottom Section: Full-Width Weekly Calendar -->
  <div class="dashboard-section">
    <div class="stat-card">
      <!-- Week Navigation -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem;">
        <%= link_to "â† #{t('previous_week', default: 'Previous Week')}", root_path(week_offset: @week_offset - 1), class: "button small secondary" %>
        <h2 style="margin: 0; flex: 1; text-align: center;">
          <%= @current_week_start.strftime("%b %d") %> - <%= @current_week_end.strftime("%b %d, %Y") %>
        </h2>
        <%= link_to "#{t('next_week', default: 'Next Week')} â†’", root_path(week_offset: @week_offset + 1), class: "button small secondary" %>
      </div>
      
      <% if @week_offset != 0 %>
        <div style="text-align: center; margin-bottom: 1rem;">
          <%= link_to t('today', default: 'Today'), root_path, class: "button small primary" %>
        </div>
      <% end %>
      
      <!-- Weekly Calendar Grid with Time Slots -->
      <div style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: white;">
        <!-- Header Row -->
        <div style="background: #f7fafc; border-right: 1px solid var(--border-color); border-bottom: 2px solid var(--border-color);"></div>
        <% (@current_week_start..@current_week_end).each do |date| %>
          <div style="background: <%= date == Date.current ? 'var(--primary-color-light, #e3f2fd)' : '#f7fafc' %>; padding: 0.75rem; text-align: center; border-right: 1px solid var(--border-color); border-bottom: 2px solid var(--border-color);">
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">
              <%= date.strftime("%a") %>
            </div>
            <div style="font-size: 1.1rem; font-weight: bold; color: <%= date == Date.current ? 'var(--primary-color)' : 'inherit' %>; margin-top: 0.25rem;">
              <%= date.day %>
            </div>
          </div>
        <% end %>
        
        <!-- Time Grid (8 AM to 8 PM, 1-hour blocks) -->
        <% (8..20).each do |hour| %>
          <!-- Time Label -->
          <div style="background: #f7fafc; padding: 0.75rem 0.5rem; text-align: right; font-size: 0.75rem; color: var(--text-muted); font-weight: 500; border-right: 1px solid var(--border-color); border-bottom: 1px solid #cbd5e0;">
            <%= sprintf("%02d:00", hour) %>
          </div>
          
          <!-- Day Columns -->
          <% (@current_week_start..@current_week_end).each do |date| %>
            <div style="position: relative; min-height: 70px; border-right: 1px solid var(--border-color); border-bottom: 1px solid #cbd5e0; background: <%= date == Date.current ? '#fafcff' : 'white' %>;">
              <% day_appointments = @appointments_by_date[date] || [] %>
              <% day_appointments.each do |appt| %>
                <% appt_hour = appt.date_time.hour %>
                <% if appt_hour == hour %>
                  <div style="position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px; background: var(--primary-color); color: white; padding: 0.5rem; border-radius: 4px; font-size: 0.75rem; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 0.3rem;">
                    <%= link_to patient_consultation_path(appt.patient, appt), style: "color: white; text-decoration: none; display: block;" do %>
                      <div style="font-weight: bold; font-size: 0.8rem;"><%= appt.date_time.strftime("%H:%M") %></div>
                      <div style="font-size: 0.7rem; line-height: 1.2;"><%= appt.patient.name %></div>
                    <% end %>
                    <% if appt.google_calendar_url %>
                      <div style="margin-top: auto;">
                        <%= link_to "ðŸ“… #{t('add_to_google_calendar')}", appt.google_calendar_url, target: "_blank", style: "color: white; text-decoration: none; font-size: 0.65rem; opacity: 0.9; display: inline-block; background: rgba(255,255,255,0.2); padding: 0.2rem 0.4rem; border-radius: 3px;" %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
